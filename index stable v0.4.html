<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clicker Game</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            background-color: white;
        }

        /* Left Sidebar */
        #left-sidebar {
            width: 25%;
            height: 100%;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            border: 4px solid black;
            box-sizing: border-box;
        }

        #left-sidebar h1 {
            margin: 0;
            padding: 10px;
            border: 1px solid black;
            box-sizing: border-box;
        }

        #left-sidebar .buttons-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .section-btn {
            width: 100%;
            padding: 10px;
            border: 2px solid black;
            background-color: white;
            cursor: pointer;
            box-sizing: border-box;
            text-align: center;
            position: relative;
        }

        .tab-btn, .item-btn {
            padding: 10px;
            border: 2px solid black;
            background-color: white;
            cursor: pointer;
            box-sizing: border-box;
            text-align: center;
            position: relative;
            width: fit-content;
            white-space: nowrap;
        }

        .tab-btn.locked, .item-btn.locked, .section-btn.locked {
            pointer-events: none;
            opacity: 0.5;
        }

        .tab-btn:hover .modal, .item-btn:hover .modal, .section-btn:hover .modal {
            display: block;
        }

        /* Modal Style */
        .modal {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            width: max-content;
            padding: 10px;
            margin-top: 10px;
            border: 1px solid black;
            background-color: white;
            box-sizing: border-box;
            z-index: 1;
        }

        /* Right Side */
        #right-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            border: 1px solid black;
            box-sizing: border-box;
        }

        #tabs-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding-bottom: 10px;
        }

        #items-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #number-display {
            font-size: 24px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <div id="left-sidebar">
        <h1 id="number-display">ℕ: 20</h1>
        <div id="number-per-second">ℕ per second: 0</div>
        <div class="buttons-container" id="sections-container"></div>
    </div>

    <div id="right-content">
        <div id="tabs-container"></div>
        <div id="items-container"></div>
    </div>

    <script>
        // Game State
        let gameState = {
            numbers: 20,
            numbersPerSecond: 0,
            sections: {},
            tabs: {},
            items: {},
            unlocked: {
                sections: {},
                tabs: {},
                items: {}
            },
            activeSection: null,  // Track the currently active section
            activeTab: null       // Track the currently active tab
        };

        // Configurable Data
        const gameConfig = {
            sections: [
                {
                    id: 'section-numbers',
                    name: 'Numbers',
                    modalMessage: "Don't ask a mathematician what a number is",
                    shownFrom: 0,
                    tabs: [
                        {
                            id: 'tabs-numbers-1',
                            name: 'Natural',
                            modalMessage: '{{}}+{{}}={{},{{}}}',
                            shownFrom: 0,
                            items: [
                                {
                                    id: 'item-numbers-n',
                                    name: 'n',
                                    modalMessage: 'Details about Numbers Item 1',
                                    basePrice: 10,
                                    priceFunction: (amountOwned) => 10 * Math.pow(2, amountOwned),
                                    nPerSecondFunction: (amountOwned) => 0,
                                    shownFrom: 0
                                },
                                {
                                    id: 'item-numbers-m',
                                    name: 'm',
                                    modalMessage: 'Details about Numbers Item 2',
                                    basePrice: 200,
                                    priceFunction: (amountOwned) => 200 * Math.pow(3, amountOwned),
                                    nPerSecondFunction: (amountOwned) => 0,
                                    shownFrom: 0
                                },
                                {
                                    id: 'item-numbers-a',
                                    name: 'a',
                                    modalMessage: 'Details about Numbers Item 3',
                                    basePrice: 5000,
                                    priceFunction: (amountOwned) => 5000 * Math.pow(4, amountOwned),
                                    nPerSecondFunction: (amountOwned) => 0,
                                    shownFrom: 1000
                                }
                            ]
                        }
                    ]
                },
                {
                    id: 'section-functions',
                    name: 'Functions',
                    modalMessage: 'These usually do something useful',
                    shownFrom: 0,
                    tabs: [
                        {
                            id: 'tabs-functions-operations',
                            name: 'Trivial',
                            modalMessage: 'We shall start from the basics',
                            shownFrom: 0,
                            items: [
                                {   
                                    id: 'item-functions-trivial-constant',
                                    name: 'Constant',   
                                    modalMessage: 'dN/dt = 1',
                                    basePrice: 50,
                                    priceFunction: (amountOwned) => Math.floor(50 * Math.pow(1.5, amountOwned)),
                                    nPerSecondFunction: (amountOwned) => 1 * amountOwned,
                                    shownFrom: 0
                                },
                                {
                                    id: 'item-functions-trivial-identity',
                                    name: 'Identity',   
                                    modalMessage: 'dN/dt = n',
                                    basePrice: 10,
                                    priceFunction: (amountOwned) => Math.floor(10 * Math.pow(1.5, amountOwned)),
                                    nPerSecondFunction: (amountOwned) => {
                                        const nValue = gameState.items['item-numbers-n']?.amountOwned || 0;
                                        return nValue * amountOwned;
                                    },
                                    shownFrom: 0
                                }
                            ]
                        }
                    ]
                }
            ]
        };

        // Centralized Render Function
        function renderGame() {
            console.log("Rendering game...");

            // Clear existing content
            document.getElementById('sections-container').innerHTML = '';
            document.getElementById('tabs-container').innerHTML = '';
            document.getElementById('items-container').innerHTML = '';

            // Render sections
            gameConfig.sections.forEach(section => {
                if (gameState.numbers >= section.shownFrom || gameState.unlocked.sections[section.id]) {
                    gameState.unlocked.sections[section.id] = true;

                    const sectionButton = document.createElement('div');
                    sectionButton.className = 'section-btn';
                    sectionButton.textContent = section.name;
                    sectionButton.onclick = () => {
                        gameState.activeSection = section.id;
                        gameState.activeTab = null;  // Reset activeTab when changing sections
                        renderTabs(section.id);
                    };

                    const sectionModal = document.createElement('div');
                    sectionModal.className = 'modal';
                    sectionModal.textContent = section.modalMessage;
                    sectionButton.appendChild(sectionModal);

                    document.getElementById('sections-container').appendChild(sectionButton);
                }
            });

            // Render the currently active section's tabs and items
            if (gameState.activeSection) {
                renderTabs(gameState.activeSection);
            } else {
                const firstSection = gameConfig.sections.find(section => gameState.unlocked.sections[section.id]);
                if (firstSection) renderTabs(firstSection.id);
            }
        }

        // Render Tabs and Items for a Given Section
        function renderTabs(sectionId) {
            const section = gameConfig.sections.find(sec => sec.id === sectionId);
            if (!section) return;

            document.getElementById('tabs-container').innerHTML = '';
            document.getElementById('items-container').innerHTML = ''; // Clear items when changing tabs

            section.tabs.forEach(tab => {
                if (gameState.numbers >= tab.shownFrom || gameState.unlocked.tabs[tab.id]) {
                    gameState.unlocked.tabs[tab.id] = true;

                    const tabButton = document.createElement('div');
                    tabButton.className = 'tab-btn';
                    tabButton.textContent = tab.name;
                    tabButton.onclick = () => {
                        gameState.activeTab = tab.id;
                        renderItems(tab.id);
                    };

                    const tabModal = document.createElement('div');
                    tabModal.className = 'modal';
                    tabModal.textContent = tab.modalMessage;
                    tabButton.appendChild(tabModal);

                    document.getElementById('tabs-container').appendChild(tabButton);
                }
            });

            // Automatically show items for the currently active tab or the first available tab
            if (gameState.activeTab) {
                renderItems(gameState.activeTab);
            } else {
                const firstTab = section.tabs.find(tab => gameState.unlocked.tabs[tab.id]);
                if (firstTab) {
                    gameState.activeTab = firstTab.id;
                    renderItems(firstTab.id);
                }
            }
        }

        // Render Items for a Given Tab
        function renderItems(tabId) {
            const tab = gameConfig.sections.flatMap(section => section.tabs).find(t => t.id === tabId);
            if (!tab) return;

            document.getElementById('items-container').innerHTML = '';

            tab.items.forEach(item => {
                // Ensure that the item state is initialized
                if (!gameState.items[item.id]) {
                    gameState.items[item.id] = { amountOwned: 0, ...item };
                }

                if (gameState.numbers >= item.shownFrom || gameState.unlocked.items[item.id]) {
                    gameState.unlocked.items[item.id] = true;

                    const itemButton = document.createElement('div');
                    itemButton.className = 'item-btn';
                    const newPrice = item.priceFunction(gameState.items[item.id].amountOwned);
                    itemButton.textContent = `${item.name} - Price: ${newPrice} ℕ - Owned: ${gameState.items[item.id].amountOwned}`;
                    itemButton.onclick = () => buyItem(item.id);

                    const itemModal = document.createElement('div');
                    itemModal.className = 'modal';
                    itemModal.textContent = item.modalMessage;
                    itemButton.appendChild(itemModal);

                    document.getElementById('items-container').appendChild(itemButton);

                    // Store a reference to the button in the game state
                    gameState.items[item.id].buttonRef = itemButton;
                }
            });
        }

        // Buy Item
        function buyItem(itemId) {
            const item = gameState.items[itemId];
            if (!item) return;

            const price = item.priceFunction(item.amountOwned);
            if (gameState.numbers >= price) {
                gameState.numbers -= price;
                item.amountOwned += 1;
                updateNumbersPerSecond();
                updateNumberDisplay();  // Update display immediately after purchase

                // Update the button text immediately
                const newPrice = item.priceFunction(item.amountOwned);
                item.buttonRef.textContent = `${item.name} - Price: ${newPrice} ℕ - Owned: ${item.amountOwned}`;
            }
        }

        // Update N per second calculations based on owned items
        function updateNumbersPerSecond() {
            gameState.numbersPerSecond = gameConfig.sections.flatMap(section => section.tabs)
                .flatMap(tab => tab.items)
                .reduce((total, item) => total + item.nPerSecondFunction(gameState.items[item.id]?.amountOwned || 0), 0);
        }

        // Update Display
        function updateNumberDisplay() {
            document.getElementById('number-display').textContent = `ℕ: ${gameState.numbers}`;
            document.getElementById('number-per-second').textContent = `ℕ per second: ${gameState.numbersPerSecond}`;
        }

        // Increment numbers per second
        function incrementNumbers() {
            gameState.numbers += gameState.numbersPerSecond;
            updateNumberDisplay();
            renderGame(); // Re-render game elements after incrementing N
        }

        // Initialize the game on window load
        window.onload = function() {
            renderGame();
            updateNumbersPerSecond();
            updateNumberDisplay();
            setInterval(incrementNumbers, 1000);
        };
    </script>
</body>
</html>
